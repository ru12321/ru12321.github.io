---
title: 微服务架构演变
date: 2024-01-17
category: 系统设计
---

### 微服务演变

灿哥分享。一篇非常精彩，逻辑清晰的精品文章，推荐全篇阅读原文：http://dw-z.ink/3VaXd

---

8000 字 + 21 张图，服务端高并发分布式架构 14 次演进之路

#### 1.基本概念

- 分布式：系统中的**多个模块在不同服务器上**部署，即可称为分布式系统
- 高可用：系统中**部分节点失效时，其他节点能够接替它继续提供服务**，则可认为系统具有高可用性
- 集群：一个特定领域的软件**部署在多台服务器上**并**作为一个整体提供一类服务**，这个整体称为集群。当集群中一个节点掉线时，其他节点往往能够自动的接替它继续提供服务，说明集群具有高可用性
- 负载均衡：请求发送到系统时，通过某些方式**把请求均匀分发到多个节点**上，使系统中每个节点能够均匀的处理请求负载
- 正向代理和反向代理：系统内部要访问外部网络时，统一通过一个**代理服务器把请求转发出去**，在外部网络看来就是代理服务器发起的访问，此时代理服务器实现的是正向代理；当外部请求进入系统时，**代理服务器把该请求转发到系统中的某台服务器上**，对外部请求来说，与之交互的只有代理服务器，此时代理服务器实现的是反向代理。简单来说，正向代理是代理服务器代替系统内部来访问外部网络的过程，反向代理是外部请求访问系统时通过代理服务器转发到内部服务器的过程。

#### 2.架构演进

淘宝为例子，并发量巨大！！！

##### 2.1 单机架构


![image-20220902221907329](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022219906.png)

##### 2.2 Tomcat与数据库**分开部署**

好处：Tomcat和数据库分别独占服务器资源，显著提高两者各自性能；

问题：但是随着用户数的增长，**并发读写数据库**成为瓶颈

##### 2.3 引入**本地缓存**和**分布式缓存**

![image-20220902221935668](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022219319.png)

好处：通过缓存能把绝大多数请求在读写数据库前拦截掉，**大大降低数据库压力**

问题：随着用户数的增长，**并发压力主要落在单机的Tomcat上**，响应逐渐变慢

##### 2.4 引入反向代理实现负载均衡

![image-20220902221953133](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022219232.png)

好处：把请求均匀分发到每个Tomcat中，使应用服务器可支持的**并发量大大增加**

问题：并发量的增长也意味着更多请求穿透到数据库，**单机的数据库**最终成为瓶颈

##### 2.5 数据库读写分离

好处：数据库划分为读库和写库，读库可以有多个，通过同步机制把写库的数据同步到读库

问题：业务逐渐变多不同业务直接竞争数据库，相互影响性能



##### 2.6 数据库按业务分库

![image-20220902222009356](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022220823.png)

好处：业务之间的资源竞争降低，对于访问量大的业务，可以部署更多的服务器来支撑

问题：**随着用户数的增长，单机的写库会逐渐会达到性能瓶颈**

##### ==2.7 把大表拆分为小表==

分布式数据库，开始不懂~

![image-20220902222029829](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022220454.png)

好处：**数据库和Tomcat都能够水平扩展，可支撑的并发大幅提高，**

问题：**随着用户数的增长，最终单机的Nginx会成为瓶颈**

##### ==2.8 使用LVS或F5来使多个Nginx负载均衡==

![image-20220902222043950](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022220956.png)



问题：由于LVS也是单机的，随着并发数增长到几十万时，LVS服务器最终会达到瓶颈。此时用户数达到千万甚至上亿级别，用户分布在不同的地区，与服务器机房距离不同，导致了访问的延迟会明显不同



##### 2.9 通过DNS轮询实现机房间的负载均衡

在DNS服务器中可配置一个域名对应多个IP地址，每个IP地址对应到不同的机房里的虚拟IP。



好处：实现**机房间的负载均衡**，至此，系统可做到机房级别的水平扩展

问题：**数据**的丰富程度和**业务**的发展，检索、分析等**需求越来越丰富**，单单依靠数据库无法解决如此丰富的需求

##### 2.10 引入NoSQL数据库和搜索引擎等技术

对于**统计报表**场景，在数据量大时不一定能跑出结果，而且在跑**复杂查询**时会导致其他查询变慢；对于**全文检索、可变数据结构**等场景，数据库天生不适用；

![image-20220902222116871](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022221672.png)



问题：**引入更多组件**解决了丰富的需求，业务维度能够极大扩充，随之而来的是一个应用中包含了太多的业务代码，**业务的升级迭代变得困难**

##### 2.11 大应用拆分为小应用

问题：**不同应用之间存在共用的模块**，不好升级

##### 2.12 复用的功能抽离成微服务

如用户管理、订单、支付、鉴权等功能在多个应用中都存在，那么可以把这些功能的代码单独抽取出来**形成一个单独的服务来管理**

![image-20220902222137558](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022221722.png)

问题：不同服务的接口访问方式不同，应用代码需要适配多种访问方式才能使用服务，此外，应用访问服务，服务之间也可能相互访问，**调用链将会变得非常复杂**，逻辑变得混乱

##### 2.13 引入企业服务总线ESB屏蔽服务接口的访问差异

ESB统一进行访问协议转换。这种单个应用拆分为多个应用，公共服务单独抽取出来来管理，并使用企业消息总线来**解除服务之间耦合问题**的架构，就是所谓的**SOA（面向服务）架构**

![image-20220902222154206](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022221646.png)

问题：同一台服务器上部署多个服务还要解决运行环境冲突的问题，部署运维困难

##### ==2.14 引入**容器化技术**实现运行环境隔离与动态服务管理==

目前最流行的容器化技术是Docker，最流行的**容器管理服务**是Kubernetes(K8S)，应用/服务可以打包为Docker镜像，通过**K8S来动态分发和部署镜像**；

![image-20220902222219939](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022222140.png)

问题：在非大促的时候，还是需要**闲置着大量的机器资源**来应对大促，机器自身成本和运维成本都极高，资源利用率低

##### ==2.15 以云平台承载系统==

![image-20220902222238988](https://picbed-for-mrru-mdfile.oss-cn-chengdu.aliyuncs.com/mrru-mdfile/202209022222598.png)

部署到公有云，大促时临时申请更多的资源，按需付费

云平台，就是把**海量机器资源**，通过**统一的资源管理**，抽象为一个资源整体，在之上可按需动态申请硬件资源（如CPU、内存、网络等），并且之上**提供通用的操作系统**，**提供常用的技术组件**（如Hadoop技术栈，MPP数据库等）供用户使用，甚至提供**开发好的应用**，用户不需要关系应用内部使用了什么技术，就能够解决需求（如音视频转码服务、邮件服务、个人博客等）。在云平台中会涉及如下几个概念：

- **IaaS：**基础设施即服务。对应于上面所说的机器资源统一为资源整体，可动态申请硬件资源的层面；
- **PaaS：**平台即服务。对应于上面所说的提供**常用的技术组件**方便系统的开发和维护；
- **SaaS：**软件即服务。对应于上面所说的提供开发好的应用或服务，按功能或性能要求付费。

#### 3.架构设计总结

- **架构的调整是否必须按照上述演变路径进行？**不是的，以上所说的架构演变顺序只是针对某个侧面进行单独的改进，在实际场景中，可能同一时间会有几个问题需要解决，或者可能先达到瓶颈的是另外的方面，这时候就**应该按照实际问题实际解决**。如在政府类的并发量可能不大，但业务可能很丰富的场景，高并发就不是重点解决的问题，此时优先需要的可能会是丰富需求的解决方案。

- **对于将要实施的系统，架构应该设计到什么程度？**对于单次实施并且性能指标明确的系统，架构设计到**能够支持系统的性能指标要求**就足够了，但要留有扩展架构的接口以便不备之需。

- **服务端架构和大数据架构有什么区别？**所谓的“大数据”其实是海量数据采集清洗转换、数据存储、数据分析、数据服务等场景解决方案的一个统称，在每一个场景都包含了多种可选的技术，如数据采集有Flume、Sqoop、Kettle等，数据存储有分布式文件系统HDFS、FastDFS，NoSQL数据库HBase、MongoDB等，数据分析有Spark技术栈、机器学习算法等。总的来说大数据架构就是根据业务的需求，**整合各种大数据组件组合而成的架构**，一般会提供分布式存储、分布式计算、多维分析、数据仓库、机器学习算法等能力。而**服务端架构更多指的是应用组织层面的架构**，底层能力往往是由大数据架构来提供。

- **有没有一些架构设计的原则？**

- - ==N+1设计==。系统中的每个组件都应做到没有单点故障；
  - ==回滚设计==。确保系统可以向前兼容，在系统升级时应能有办法回滚版本；
  - ==禁用设计==。应该提供控制具体功能是否可用的配置，在系统出现故障时能够快速下线功能；
  - 监控设计。在设计阶段就要考虑监控的手段；
  - ==多活数据中心设计==。若系统需要极高的高可用，应考虑在多地实施数据中心进行多活，至少在一个机房断电的情况下系统依然可用；
  - 采用成熟的技术。刚开发的或开源的技术往往存在很多隐藏的bug，出了问题没有商业支持可能会是一个灾难；
  - ==资源隔离设计==。应避免单一业务占用全部资源；
  - 架构应能==水平扩展==。系统只有做到能水平扩展，才能有效避免瓶颈问题；
  - 非核心则购买。非核心功能若需要占用大量的研发资源才能解决，则考虑购买成熟的产品；
  - 使用商用硬件。商用硬件能有效降低硬件故障的机率；
  - ==快速迭代==。系统应该快速开发小功能模块，尽快上线进行验证，早日发现问题大大降低系统交付的风险；
  - ==无状态设计==。服务接口应该做成无状态的，当前接口的访问不依赖于接口上次访问的状态。

---

#### 4.问题

> 2.7 ，2.8 ，2.13不理解



> 商用硬件和无状态不理解



---

ps:微服务架构另一篇文章：https://www.cnblogs.com/liuning8023/p/4493156.html